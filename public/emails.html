<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Disparador de E-mails</title>
    <style>
        body {
            font-family: Arial;
            margin: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background: #f0f0f0;
        }

        .loading {
            display: none;
            font-weight: bold;
            color: blue;
        }

        .status {
            cursor: pointer;
            text-decoration: underline;
        }

        .status[data-status="enviado"] {
            color: green;
            font-weight: bold;
        }

        .status[data-status="pendente"] {
            color: orange;
            font-weight: bold;
        }

        .status[data-status="finalizado"] {
            color: gray;
            font-style: italic;
        }

        .status[data-status="não enviado"] {
            color: red;
            font-weight: bold;
        }

        #contador {
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h2>Selecione os e-mails para enviar</h2>
    <div id="contador">Carregando...</div>
    <button type="button" id="resetarStatus" style="margin-left: 10px;">Resetar todos para NÃO ENVIADO</button>


    <form id="formEmails">
        <table>
            <thead>
                <tr>
                    <th>Selecionar</th>
                    <th>Código da Empresa</th>
                    <th>Nome da Empresa</th>
                    <th>CNPJ</th>
                    <th>Email</th>
                    <th>Situação</th>
                    <th>Status</th>
                    <th>Visualizado</th>

                </tr>
            </thead>
            <tbody id="tabela"></tbody>
        </table>
        <button type="submit">Enviar E-mails Selecionados</button>
        <div class="loading">Enviando e-mails, aguarde...</div>
    </form>

    <script>
        async function carregarContatos() {
            try {
                const res = await fetch('/contatos');
                if (!res.ok) throw new Error("Erro ao carregar contatos.");
                const contatos = await res.json();

                const tbody = document.getElementById('tabela');
                tbody.innerHTML = '';

                let pendentes = 0;

            contatos.forEach(c => {
    const status = c.status?.toLowerCase() || 'não enviado';
    if (status === 'não enviado') pendentes++;

    const tr = document.createElement('tr');
    tr.dataset.codEmpresa = c.cod;

    // Adicionando a lógica para exibir a mensagem de visualização
 let visualizadoMessage = c.visualizado ? 'Sim' : '—';


    tr.innerHTML = `
        <td><input type="checkbox" name="selecionado" value='${JSON.stringify(c)}'></td>
        <td>${c.cod}</td>
        <td>${c.nome}</td>
        <td>${c.cnpj}</td>
        <td>${c.email}</td>
        <td>${c.situacao}</td>
        <td class="status" data-status="${status}">${c.status || 'Não enviado'}</td>
        <td>${visualizadoMessage}</td>
    `;
    tbody.appendChild(tr);
});


                document.getElementById('contador').textContent = `Pendentes para envio: ${pendentes}`;
            } catch (err) {
                alert(`Erro: ${err.message}`);
                document.getElementById('contador').textContent = 'Erro ao carregar.';
            }
        }

        document.getElementById('formEmails').addEventListener('submit', async (e) => {
            e.preventDefault();
            const checkboxes = document.querySelectorAll('input[name="selecionado"]:checked');
            const selecionados = Array.from(checkboxes).map(cb => JSON.parse(cb.value));
            if (selecionados.length === 0) return alert("Selecione pelo menos um e-mail.");

            const loading = document.querySelector('.loading');
            loading.style.display = 'block';

            try {
                const res = await fetch('/enviar-emails', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emails: selecionados })
                });

                if (!res.ok) throw new Error("Erro ao enviar e-mails.");

                const result = await res.json();
                alert(`Foram enviados ${result.enviados} e-mails com sucesso.`);
                carregarContatos(); // Atualiza a tabela e contador
            } catch (err) {
                alert(`Erro: ${err.message}`);
            } finally {
                loading.style.display = 'none';
            }
        });

        document.getElementById('resetarStatus').addEventListener('click', async () => {
            if (!confirm("Tem certeza que deseja resetar todos os status para 'NÃO ENVIADO'?")) return;

            try {
                const res = await fetch('/resetar-status', { method: 'POST' });
                if (!res.ok) throw new Error("Erro ao resetar status.");
                alert("Todos os status foram resetados com sucesso.");
                carregarContatos();
            } catch (err) {
                alert(`Erro: ${err.message}`);
            }
        });


        carregarContatos();
    </script>
</body>

</html>
